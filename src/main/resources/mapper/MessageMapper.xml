<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.study.service.message.MessageMapper">

    <!-- 结果映射 -->
    <resultMap id="messageResultMap" type="com.study.service.message.Message">
        <id property="id" column="id" jdbcType="BIGINT"/>
        <result property="senderId" column="sender_id" jdbcType="BIGINT"/>
        <result property="senderName" column="sender_name" jdbcType="VARCHAR"/>
        <result property="senderType" column="sender_type" jdbcType="VARCHAR"/>
        <result property="receiverId" column="receiver_id" jdbcType="BIGINT"/>
        <result property="applicationId" column="application_id" jdbcType="BIGINT"/>
        <result property="title" column="title" jdbcType="VARCHAR"/>
        <result property="content" column="content" jdbcType="LONGVARCHAR"/>
        <result property="messageType" column="message_type" jdbcType="VARCHAR"/>
        <result property="priority" column="priority" jdbcType="VARCHAR"/>
        <result property="isRead" column="is_read" jdbcType="BOOLEAN"/>
        <result property="readAt" column="read_at" jdbcType="TIMESTAMP"/>
        <result property="requiresReply" column="requires_reply" jdbcType="BOOLEAN"/>
        <result property="isReplied" column="is_replied" jdbcType="BOOLEAN"/>
        <result property="repliedAt" column="replied_at" jdbcType="TIMESTAMP"/>
        <result property="attachmentUrl" column="attachment_url" jdbcType="VARCHAR"/>
        <result property="expiresAt" column="expires_at" jdbcType="TIMESTAMP"/>
        <result property="status" column="status" jdbcType="VARCHAR"/>
        <result property="createdAt" column="created_at" jdbcType="TIMESTAMP"/>
        <result property="updatedAt" column="updated_at" jdbcType="TIMESTAMP"/>
    </resultMap>

    <!-- 公共字段列表 -->
    <sql id="baseColumns">
        id, sender_id, sender_name, sender_type, receiver_id, application_id,
        title, content, message_type, priority, is_read, read_at,
        requires_reply, is_replied, replied_at, attachment_url,
        expires_at, status, created_at, updated_at
    </sql>

    <!-- 根据接收者ID获取消息列表 -->
    <select id="findByReceiverId" resultMap="messageResultMap">
        SELECT <include refid="baseColumns"/>
        FROM messages
        WHERE receiver_id = #{receiverId}
        AND status = 'active'
        ORDER BY created_at DESC
    </select>

    <!-- 根据接收者ID和申请ID获取消息列表 -->
    <select id="findByReceiverIdAndApplicationId" resultMap="messageResultMap">
        SELECT <include refid="baseColumns"/>
        FROM messages
        WHERE receiver_id = #{receiverId}
        AND application_id = #{applicationId}
        AND status = 'active'
        ORDER BY created_at DESC
    </select>

    <!-- 根据ID获取消息详情 -->
    <select id="findById" resultMap="messageResultMap">
        SELECT <include refid="baseColumns"/>
        FROM messages
        WHERE id = #{id}
        AND status = 'active'
    </select>

    <!-- 插入新消息 -->
    <insert id="insert" parameterType="com.study.service.message.Message" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO messages (
            sender_id, sender_name, sender_type, receiver_id, application_id,
            title, content, message_type, priority, is_read,
            requires_reply, is_replied, attachment_url, expires_at,
            status, created_at, updated_at
        ) VALUES (
            #{senderId}, #{senderName}, #{senderType}, #{receiverId}, #{applicationId},
            #{title}, #{content}, #{messageType}, #{priority}, #{isRead},
            #{requiresReply}, #{isReplied}, #{attachmentUrl}, #{expiresAt},
            #{status}, NOW(), NOW()
        )
    </insert>

    <!-- 更新消息 -->
    <update id="update" parameterType="com.study.service.message.Message">
        UPDATE messages
        SET
            title = #{title},
            content = #{content},
            message_type = #{messageType},
            priority = #{priority},
            attachment_url = #{attachmentUrl},
            expires_at = #{expiresAt},
            status = #{status},
            updated_at = NOW()
        WHERE id = #{id}
    </update>

    <!-- 标记消息为已读 -->
    <update id="markAsRead">
        UPDATE messages
        SET is_read = true, read_at = NOW(), updated_at = NOW()
        WHERE id = #{id}
    </update>

    <!-- 批量标记消息为已读 -->
    <update id="markAsReadBatch">
        UPDATE messages
        SET is_read = true, read_at = NOW(), updated_at = NOW()
        WHERE id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>

    <!-- 删除消息 -->
    <update id="deleteById">
        UPDATE messages
        SET status = 'deleted', updated_at = NOW()
        WHERE id = #{id}
    </update>

    <!-- 获取未读消息数量 -->
    <select id="countUnreadMessages" resultType="int">
        SELECT COUNT(*)
        FROM messages
        WHERE receiver_id = #{receiverId}
        AND is_read = false
        AND status = 'active'
    </select>

    <!-- 根据发送者ID获取消息列表 -->
    <select id="findBySenderId" resultMap="messageResultMap">
        SELECT <include refid="baseColumns"/>
        FROM messages
        WHERE sender_id = #{senderId}
        AND status = 'active'
        ORDER BY created_at DESC
    </select>

    <!-- 根据消息类型获取消息列表 -->
    <select id="findByReceiverIdAndType" resultMap="messageResultMap">
        SELECT <include refid="baseColumns"/>
        FROM messages
        WHERE receiver_id = #{receiverId}
        AND message_type = #{messageType}
        AND status = 'active'
        ORDER BY created_at DESC
    </select>

</mapper>