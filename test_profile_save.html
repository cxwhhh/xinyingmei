<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profileä¿å­˜åŠŸèƒ½æµ‹è¯•</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #fafafa;
        }
        .test-section h3 {
            color: #2c3e50;
            margin-top: 0;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .form-row {
            display: flex;
            gap: 15px;
        }
        .form-row .form-group {
            flex: 1;
        }
        button {
            background-color: #3498db;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background-color: #2980b9;
        }
        button.success {
            background-color: #27ae60;
        }
        button.danger {
            background-color: #e74c3c;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .user-info {
            background-color: #e7f3ff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª Profileä¿å­˜åŠŸèƒ½æµ‹è¯•</h1>
        
        <div class="user-info">
            <h4>å½“å‰æµ‹è¯•ç”¨æˆ·ä¿¡æ¯</h4>
            <p><strong>ç”¨æˆ·ID:</strong> <span id="currentUserId">45</span></p>
            <p><strong>å­¦ç”ŸID:</strong> <span id="currentStudentId">123160</span></p>
            <p><strong>ç”¨æˆ·å:</strong> testuser2</p>
        </div>

        <!-- è·å–å­¦ç”Ÿä¿¡æ¯æµ‹è¯• -->
        <div class="test-section">
            <h3>1. è·å–å­¦ç”Ÿä¿¡æ¯æµ‹è¯•</h3>
            <button onclick="getStudentInfo()">è·å–å­¦ç”Ÿä¿¡æ¯</button>
            <div id="getResult" class="result" style="display:none;"></div>
        </div>

        <!-- å­¦ç”Ÿä¿¡æ¯ç¼–è¾‘è¡¨å• -->
        <div class="test-section">
            <h3>2. å­¦ç”Ÿä¿¡æ¯ç¼–è¾‘è¡¨å•</h3>
            <form id="studentForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="name">å§“å *</label>
                        <input type="text" id="name" name="name" required>
                    </div>
                    <div class="form-group">
                        <label for="englishName">è‹±æ–‡å</label>
                        <input type="text" id="englishName" name="englishName">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="gender">æ€§åˆ«</label>
                        <select id="gender" name="gender">
                            <option value="">è¯·é€‰æ‹©</option>
                            <option value="ç”·">ç”·</option>
                            <option value="å¥³">å¥³</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="birthDate">å‡ºç”Ÿæ—¥æœŸ</label>
                        <input type="date" id="birthDate" name="birthDate">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="nationality">å›½ç±</label>
                        <input type="text" id="nationality" name="nationality">
                    </div>
                    <div class="form-group">
                        <label for="passportNo">æŠ¤ç…§å·</label>
                        <input type="text" id="passportNo" name="passportNo">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="phone">ç”µè¯</label>
                        <input type="tel" id="phone" name="phone">
                    </div>
                    <div class="form-group">
                        <label for="email">é‚®ç®±</label>
                        <input type="email" id="email" name="email">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="wechat">å¾®ä¿¡</label>
                        <input type="text" id="wechat" name="wechat">
                    </div>
                    <div class="form-group">
                        <label for="gpa">GPA</label>
                        <input type="number" id="gpa" name="gpa" step="0.1" min="0" max="4">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="currentSchool">å½“å‰å­¦æ ¡</label>
                        <input type="text" id="currentSchool" name="currentSchool">
                    </div>
                    <div class="form-group">
                        <label for="major">ä¸“ä¸š</label>
                        <input type="text" id="major" name="major">
                    </div>
                </div>
            </form>
            
            <button onclick="saveStudentInfo()">ğŸ’¾ ä¿å­˜å­¦ç”Ÿä¿¡æ¯</button>
            <button onclick="testNewUserSave()" class="success">ğŸ†• æµ‹è¯•æ–°ç”¨æˆ·ä¿å­˜</button>
            <div id="saveResult" class="result" style="display:none;"></div>
        </div>

        <!-- å®Œæ•´æµ‹è¯•æµç¨‹ -->
        <div class="test-section">
            <h3>3. å®Œæ•´æµ‹è¯•æµç¨‹</h3>
            <button onclick="runCompleteTest()" class="success">ğŸš€ è¿è¡Œå®Œæ•´æµ‹è¯•</button>
            <div id="completeTestResult" class="result" style="display:none;"></div>
        </div>
    </div>

    <script>
        const apiBaseURL = (window.location.protocol === 'http:' || window.location.protocol === 'https:')
            ? `${window.location.origin}/api`
            : 'http://localhost:8080/api';

        axios.defaults.baseURL = apiBaseURL;
        axios.defaults.headers.common['Content-Type'] = 'application/json';

        let currentStudentData = null;

        // è·å–å­¦ç”Ÿä¿¡æ¯
        async function getStudentInfo() {
            const resultDiv = document.getElementById('getResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result info';
            resultDiv.textContent = 'æ­£åœ¨è·å–å­¦ç”Ÿä¿¡æ¯...';

            try {
                const userId = document.getElementById('currentUserId').textContent;
                const response = await axios.get(`/student/info/${userId}`);
                
                if (response.data.code === 200) {
                    currentStudentData = response.data.data;
                    fillForm(currentStudentData);
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `âœ… è·å–æˆåŠŸï¼\n${JSON.stringify(response.data.data, null, 2)}`;
                    
                    // æ›´æ–°å­¦ç”ŸIDæ˜¾ç¤º
                    document.getElementById('currentStudentId').textContent = currentStudentData.id || 'æœªçŸ¥';
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `âŒ è·å–å¤±è´¥ï¼š${response.data.message}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ è¯·æ±‚å¤±è´¥ï¼š${error.message}\n${JSON.stringify(error.response?.data, null, 2)}`;
            }
        }

        // å¡«å……è¡¨å•
        function fillForm(data) {
            if (!data) return;
            
            document.getElementById('name').value = data.name || '';
            document.getElementById('englishName').value = data.englishName || '';
            document.getElementById('gender').value = data.gender || '';
            document.getElementById('nationality').value = data.nationality || '';
            document.getElementById('passportNo').value = data.passportNo || '';
            document.getElementById('phone').value = data.phone || '';
            document.getElementById('email').value = data.email || '';
            document.getElementById('wechat').value = data.wechat || '';
            document.getElementById('gpa').value = data.gpa || '';
            document.getElementById('currentSchool').value = data.currentSchool || '';
            document.getElementById('major').value = data.major || '';
            
            // å¤„ç†æ—¥æœŸæ ¼å¼
            if (data.birthDate) {
                const date = new Date(data.birthDate);
                const formattedDate = date.toISOString().split('T')[0];
                document.getElementById('birthDate').value = formattedDate;
            }
        }

        // è·å–è¡¨å•æ•°æ®
        function getFormData() {
            const formData = {
                name: document.getElementById('name').value,
                englishName: document.getElementById('englishName').value,
                gender: document.getElementById('gender').value,
                nationality: document.getElementById('nationality').value,
                passportNo: document.getElementById('passportNo').value,
                phone: document.getElementById('phone').value,
                email: document.getElementById('email').value,
                wechat: document.getElementById('wechat').value,
                gpa: parseFloat(document.getElementById('gpa').value) || null,
                currentSchool: document.getElementById('currentSchool').value,
                major: document.getElementById('major').value,
                userId: parseInt(document.getElementById('currentUserId').textContent)
            };

            // å¤„ç†å‡ºç”Ÿæ—¥æœŸ
            const birthDate = document.getElementById('birthDate').value;
            if (birthDate) {
                formData.birthDate = new Date(birthDate).getTime();
            }

            // å¦‚æœæœ‰å­¦ç”ŸIDï¼Œæ·»åŠ åˆ°æ•°æ®ä¸­
            if (currentStudentData && currentStudentData.id) {
                formData.id = currentStudentData.id;
            }

            return formData;
        }

        // ä¿å­˜å­¦ç”Ÿä¿¡æ¯
        async function saveStudentInfo() {
            const resultDiv = document.getElementById('saveResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result info';
            resultDiv.textContent = 'æ­£åœ¨ä¿å­˜å­¦ç”Ÿä¿¡æ¯...';

            try {
                const submitData = getFormData();
                console.log('æäº¤æ•°æ®:', submitData);

                let response;
                if (submitData.id) {
                    // æœ‰IDï¼Œä½¿ç”¨updateæ¥å£
                    resultDiv.textContent = 'æ£€æµ‹åˆ°å­¦ç”ŸIDï¼Œä½¿ç”¨updateæ¥å£æ›´æ–°...';
                    response = await axios.put('/student/update', submitData);
                } else {
                    // æ²¡æœ‰IDï¼Œä½¿ç”¨syncæ¥å£
                    resultDiv.textContent = 'æœªæ£€æµ‹åˆ°å­¦ç”ŸIDï¼Œä½¿ç”¨syncæ¥å£åŒæ­¥...';
                    response = await axios.post('/student/sync', submitData);
                }

                if (response.data.code === 200) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `âœ… ä¿å­˜æˆåŠŸï¼\næ¥å£ï¼š${submitData.id ? 'update' : 'sync'}\nå“åº”ï¼š${JSON.stringify(response.data, null, 2)}`;
                    
                    // é‡æ–°è·å–æ•°æ®éªŒè¯
                    setTimeout(() => {
                        getStudentInfo();
                    }, 1000);
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `âŒ ä¿å­˜å¤±è´¥ï¼š${response.data.message}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ è¯·æ±‚å¤±è´¥ï¼š${error.message}\n${JSON.stringify(error.response?.data, null, 2)}`;
            }
        }

        // æµ‹è¯•æ–°ç”¨æˆ·ä¿å­˜
        async function testNewUserSave() {
            const resultDiv = document.getElementById('saveResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result info';
            resultDiv.textContent = 'æ­£åœ¨åˆ›å»ºæ–°ç”¨æˆ·å¹¶æµ‹è¯•ä¿å­˜...';

            try {
                // 1. åˆ›å»ºæ–°ç”¨æˆ·
                const newUserData = {
                    username: `testuser_${Date.now()}`,
                    password: '123456',
                    email: `test_${Date.now()}@example.com`
                };

                const registerResponse = await axios.post('/user/register', newUserData);
                if (registerResponse.data.code !== 200) {
                    throw new Error(`ç”¨æˆ·åˆ›å»ºå¤±è´¥ï¼š${registerResponse.data.message}`);
                }

                const newUserId = registerResponse.data.data.id;
                resultDiv.textContent += `\nâœ… æ–°ç”¨æˆ·åˆ›å»ºæˆåŠŸï¼ŒID: ${newUserId}`;

                // 2. ä¸ºæ–°ç”¨æˆ·ä¿å­˜å­¦ç”Ÿä¿¡æ¯
                const studentData = {
                    userId: newUserId,
                    name: 'æ–°æµ‹è¯•ç”¨æˆ·',
                    englishName: 'New Test User',
                    gender: 'å¥³',
                    birthDate: new Date('1995-05-15').getTime(),
                    nationality: 'ä¸­å›½',
                    passportNo: 'E87654321',
                    phone: '13900139000',
                    email: newUserData.email,
                    wechat: newUserData.username,
                    currentSchool: 'æ–°æµ‹è¯•å¤§å­¦',
                    major: 'è½¯ä»¶å·¥ç¨‹',
                    gpa: 3.7
                };

                const syncResponse = await axios.post('/student/sync', studentData);
                if (syncResponse.data.code === 200) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent += `\nâœ… æ–°ç”¨æˆ·å­¦ç”Ÿä¿¡æ¯ä¿å­˜æˆåŠŸï¼\n${JSON.stringify(syncResponse.data.data, null, 2)}`;
                } else {
                    throw new Error(`å­¦ç”Ÿä¿¡æ¯ä¿å­˜å¤±è´¥ï¼š${syncResponse.data.message}`);
                }

            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent += `\nâŒ æµ‹è¯•å¤±è´¥ï¼š${error.message}`;
            }
        }

        // è¿è¡Œå®Œæ•´æµ‹è¯•
        async function runCompleteTest() {
            const resultDiv = document.getElementById('completeTestResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result info';
            resultDiv.textContent = 'å¼€å§‹è¿è¡Œå®Œæ•´æµ‹è¯•æµç¨‹...\n';

            try {
                // 1. è·å–å½“å‰å­¦ç”Ÿä¿¡æ¯
                resultDiv.textContent += '\n1. è·å–å½“å‰å­¦ç”Ÿä¿¡æ¯...';
                await getStudentInfo();
                resultDiv.textContent += ' âœ… å®Œæˆ';

                // 2. ä¿®æ”¹ä¸€äº›ä¿¡æ¯
                resultDiv.textContent += '\n2. ä¿®æ”¹å­¦ç”Ÿä¿¡æ¯...';
                document.getElementById('name').value = 'å®Œæ•´æµ‹è¯•ç”¨æˆ·';
                document.getElementById('phone').value = '13700137000';
                document.getElementById('gpa').value = '3.9';
                resultDiv.textContent += ' âœ… å®Œæˆ';

                // 3. ä¿å­˜ä¿®æ”¹
                resultDiv.textContent += '\n3. ä¿å­˜ä¿®æ”¹...';
                await new Promise(resolve => {
                    saveStudentInfo();
                    setTimeout(resolve, 2000);
                });
                resultDiv.textContent += ' âœ… å®Œæˆ';

                // 4. éªŒè¯ä¿å­˜ç»“æœ
                resultDiv.textContent += '\n4. éªŒè¯ä¿å­˜ç»“æœ...';
                const userId = document.getElementById('currentUserId').textContent;
                const verifyResponse = await axios.get(`/student/info/${userId}`);
                
                if (verifyResponse.data.code === 200) {
                    const savedData = verifyResponse.data.data;
                    if (savedData.name === 'å®Œæ•´æµ‹è¯•ç”¨æˆ·' && 
                        savedData.phone === '13700137000' && 
                        savedData.gpa === 3.9) {
                        resultDiv.className = 'result success';
                        resultDiv.textContent += ' âœ… å®Œæˆ\n\nğŸ‰ å®Œæ•´æµ‹è¯•æµç¨‹æˆåŠŸï¼æ‰€æœ‰åŠŸèƒ½æ­£å¸¸å·¥ä½œã€‚';
                    } else {
                        throw new Error('æ•°æ®éªŒè¯å¤±è´¥ï¼Œä¿å­˜çš„æ•°æ®ä¸é¢„æœŸä¸ç¬¦');
                    }
                } else {
                    throw new Error(`éªŒè¯å¤±è´¥ï¼š${verifyResponse.data.message}`);
                }

            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent += `\nâŒ æµ‹è¯•å¤±è´¥ï¼š${error.message}`;
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è·å–å­¦ç”Ÿä¿¡æ¯
        window.onload = function() {
            getStudentInfo();
        };
    </script>
</body>
</html>
